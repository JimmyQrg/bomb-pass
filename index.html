<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Bomb Pass</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
body { margin:0; background:black; display:flex; justify-content:center; align-items:center; height:100vh; }
canvas { image-rendering: pixelated; background:#000; }
#menu, #settings, #gameover {
  position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
  display:none; flex-direction:column; align-items:center;
  font-family:'Press Start 2P', monospace; background:url("images/background.png") center/cover no-repeat;
  padding:20px; border:4px solid #444;
}
#menu button, #settings button { background:none; border:none; margin:10px; cursor:pointer; }
</style>
</head>
<body>
<canvas id="gameCanvas"></canvas>

<div id="menu">
  <button id="btn2"><img src="images/buttons/start-menu/button-2-players.png"></button>
  <button id="btn3"><img src="images/buttons/start-menu/button-3-players.png"></button>
  <button id="btn4"><img src="images/buttons/start-menu/button-4-players.png"></button>
</div>

<div id="settings">
  <label style="color:white;">Time (5â€“60s): <input id="timeInput" type="number" min="5" max="60" value="20"></label>
  <button id="startBtn"><img src="images/buttons/start.png"></button>
</div>

<div id="gameover">
  <h1 id="winnerText" style="color:white;"></h1>
  <button onclick="location.reload()"><img src="images/buttons/restart.png"></button>
</div>

<script>
const canvas=document.getElementById("gameCanvas");
const ctx=canvas.getContext("2d");

let mapSize=40, grid=[], players=[], bomb=null, explosions=[], gameRunning=false, timeLeft=0, startTime=20, numPlayers=2;
let camX=0, camY=0, camZoom=1;

// Resize canvas
function resizeCanvas(){
  let size=Math.min(window.innerWidth, window.innerHeight);
  canvas.width=canvas.height=size;
}
window.addEventListener("resize", resizeCanvas);
resizeCanvas();

// Load images
const wallImg=new Image(); wallImg.src="images/blocks/wall.png";
const groundImg=new Image(); groundImg.src="images/blocks/ground-slab.png";
const bombImg=new Image(); bombImg.src="images/bomb.png";
const explosionImg=new Image(); explosionImg.src="images/bomb.png"; // can use bomb.png as placeholder
let playerImgs={};
for(let i=1;i<=4;i++){
  playerImgs[i]=new Image(); playerImgs[i].src=`images/players/player-${i}.png`;
  playerImgs[i+"b"]=new Image(); playerImgs[i+"b"].src=`images/players/player-${i}-bomb.png`;
}

// Controls
const controls=[
  {up:'KeyW',down:'KeyS',left:'KeyA',right:'KeyD',throw:'KeyQ'},
  {up:'ArrowUp',down:'ArrowDown',left:'ArrowLeft',right:'ArrowRight',throw:'Slash'},
  {up:'KeyI',down:'KeyK',left:'KeyJ',right:'KeyL',throw:'KeyU'},
  {up:'KeyT',down:'KeyG',left:'KeyF',right:'KeyH',throw:'KeyR'},
];
let keys={};

// Map generation
function generateMap(){
  grid=[];
  for(let y=0;y<mapSize;y++){
    let row=[];
    for(let x=0;x<mapSize;x++){
      if(x===0||y===0||x===mapSize-1||y===mapSize-1||Math.random()<0.15) row.push(1);
      else row.push(0);
    }
    grid.push(row);
  }
}

// Spawn players avoiding walls
function spawnPlayers(){
  players=[];
  for(let i=0;i<numPlayers;i++){
    let x,y;
    do{
      x=Math.floor(Math.random()*mapSize);
      y=Math.floor(Math.random()*mapSize);
    }while(grid[y][x]===1 || players.some(p=>p.x===x && p.y===y));
    players.push({id:i+1,x,y,alive:true,hasBomb:false});
  }
}

// Give bomb to random player
function giveBomb(){
  let alive=players.filter(p=>p.alive);
  let pick=alive[Math.floor(Math.random()*alive.length)];
  pick.hasBomb=true;
  bomb={x:pick.x,y:pick.y,dir:null,holder:pick,explodeTimer:startTime};
}

// Collision
function isBlocked(x,y){
  if(x<0||y<0||x>=mapSize||y>=mapSize) return true;
  if(grid[y][x]===1) return true;
  if(players.some(p=>p.alive && p.x===x && p.y===y)) return true;
  return false;
}

function lerp(a,b,t){ return a + (b-a)*t; }

// Explosion
function explode(x,y){
  explosions.push({x,y,frame:0});
  // check hit players
  players.forEach(p=>{
    if(p.alive && p.x===x && p.y===y){ p.alive=false; if(bomb && bomb.holder===p) bomb=null;}
  });
}

// Game loop
function update(){
  if(!gameRunning) return;

  // Movement
  players.forEach((p,i)=>{
    if(!p.alive) return;
    let ctrl=controls[i];
    let nx=p.x, ny=p.y;
    if(keys[ctrl.up]) ny--;
    if(keys[ctrl.down]) ny++;
    if(keys[ctrl.left]) nx--;
    if(keys[ctrl.right]) nx++;
    if((nx!==p.x||ny!==p.y) && !isBlocked(nx,ny)){
      p.x=nx; p.y=ny;
      if(bomb && bomb.holder===p){ bomb.x=p.x; bomb.y=p.y; }
    }
  });

  // Throw
  players.forEach((p,i)=>{
    if(!p.alive) return;
    if(bomb && bomb.holder===p){
      if(keys[controls[i].throw]){
        let dirX=0,dirY=0;
        if(keys[controls[i].up]) dirY=-1;
        else if(keys[controls[i].down]) dirY=1;
        else if(keys[controls[i].left]) dirX=-1;
        else if(keys[controls[i].right]) dirX=1;
        if(dirX||dirY){
          bomb.holder=null;
          bomb.x=p.x; bomb.y=p.y;
          bomb.dir={x:dirX,y:dirY};
          p.hasBomb=false;
        }
      }
    }
  });

  // Bomb travel
  if(bomb && !bomb.holder && bomb.dir){
    let nx=bomb.x+bomb.dir.x, ny=bomb.y+bomb.dir.y;
    if(nx<0||ny<0||nx>=mapSize||ny>=mapSize || grid[ny][nx]===1){
      bomb.dir=null;
    }else{
      let hit=players.find(pl=>pl.alive && pl.x===nx && pl.y===ny);
      if(hit){ hit.hasBomb=true; bomb.holder=hit; bomb.dir=null; }
      else { bomb.x=nx; bomb.y=ny; }
    }
  }

  // Bomb timer
  if(bomb){ bomb.explodeTimer-=(1/60); if(bomb.explodeTimer<=0){ explode(bomb.x,bomb.y); bomb=null; } }

  // Update explosions
  explosions.forEach(e=>e.frame++);
  explosions = explosions.filter(e=>e.frame<15);

  // Timer and check alive
  let alive=players.filter(p=>p.alive);
  if(alive.length<=1 && !bomb){
    gameRunning=false;
    document.getElementById("winnerText").textContent=alive.length?`Player ${alive[0].id} Wins!`:"No one wins";
    document.getElementById("gameover").style.display="flex";
  }

  // Camera
  if(alive.length>0){
    let minX=Math.min(...alive.map(p=>p.x));
    let maxX=Math.max(...alive.map(p=>p.x));
    let minY=Math.min(...alive.map(p=>p.y));
    let maxY=Math.max(...alive.map(p=>p.y));
    let boxWidth=maxX-minX+1, boxHeight=maxY-minY+1;

    let baseTile = canvas.width/mapSize;
    let fitTileX = canvas.width/boxWidth;
    let fitTileY = canvas.height/boxHeight;
    let targetZoom = Math.min(fitTileX, fitTileY);
    if(targetZoom>baseTile) targetZoom=baseTile;

    let centerX=(minX+maxX+1)/2;
    let centerY=(minY+maxY+1)/2;

    camZoom=lerp(camZoom,targetZoom,0.1);
    camX=lerp(camX,centerX-(canvas.width/(2*camZoom)),0.1);
    camY=lerp(camY,centerY-(canvas.height/(2*camZoom)),0.1);
  }

  // Draw
  ctx.clearRect(0,0,canvas.width,canvas.height);
  for(let y=0;y<mapSize;y++){
    for(let x=0;x<mapSize;x++){
      let dx=(x-camX)*camZoom;
      let dy=(y-camY)*camZoom;
      if(dx+camZoom<0||dy+camZoom<0||dx>canvas.width||dy>canvas.height) continue;
      ctx.drawImage(grid[y][x]===1?wallImg:groundImg,dx,dy,camZoom,camZoom);
    }
  }
  players.forEach(p=>{
    if(p.alive){
      let img=p.hasBomb?playerImgs[p.id+"b"]:playerImgs[p.id];
      let dx=(p.x-camX)*camZoom;
      let dy=(p.y-camY)*camZoom;
      ctx.drawImage(img,dx,dy,camZoom,camZoom);
    }
  });
  if(bomb && !bomb.holder){
    let dx=(bomb.x-camX)*camZoom;
    let dy=(bomb.y-camY)*camZoom;
    ctx.drawImage(bombImg,dx,dy,camZoom,camZoom);
  }
  explosions.forEach(e=>{
    let dx=(e.x-camX)*camZoom;
    let dy=(e.y-camY)*camZoom;
    ctx.fillStyle="orange";
    ctx.fillRect(dx,dy,camZoom,camZoom);
  });

  // Timer
  ctx.fillStyle="white"; 
  ctx.font=`${canvas.width/20}px 'Press Start 2P'`;
  ctx.fillText(Math.ceil(timeLeft),10,30);

  requestAnimationFrame(update);
}

// UI
document.getElementById("menu").style.display="flex";
document.getElementById("btn2").onclick=()=>{numPlayers=2;document.getElementById("menu").style.display="none";document.getElementById("settings").style.display="flex";};
document.getElementById("btn3").onclick=()=>{numPlayers=3;document.getElementById("menu").style.display="none";document.getElementById("settings").style.display="flex";};
document.getElementById("btn4").onclick=()=>{numPlayers=4;document.getElementById("menu").style.display="none";document.getElementById("settings").style.display="flex";};

document.getElementById("timeInput").addEventListener("input",()=>{
  let v=+document.getElementById("timeInput").value;
  let btn=document.getElementById("startBtn");
  if(v<5||v>60){ btn.querySelector("img").src="images/buttons/start-gray.png"; btn.disabled=true; }
  else { btn.querySelector("img").src="images/buttons/start.png"; btn.disabled=false; }
});

document.getElementById("startBtn").onclick=()=>{
  let v=+document.getElementById("timeInput").value;
  if(v<5||v>60) return;
  startTime=v; timeLeft=v;
  document.getElementById("settings").style.display="none";
  generateMap(); spawnPlayers(); giveBomb();
  gameRunning=true;
  update();
};

window.addEventListener("keydown",e=>{keys[e.code]=true;});
window.addEventListener("keyup",e=>{keys[e.code]=false;});
</script>
</body>
</html>
