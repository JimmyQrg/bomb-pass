<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Bomb Pass</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
  body {
    margin: 0;
    background: black;
    font-family: 'Press Start 2P', monospace;
    color: white;
    overflow: hidden;
  }
  canvas {
    display: block;
    margin: 0 auto;
    background: black;
    image-rendering: pixelated;
  }
  #menu, #settings, #gameover {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    display: none;
    flex-direction: column;
    align-items: center;
    background: url("images/background.png");
    background-size: cover;
    padding: 20px;
  }
  button {
    background: none;
    border: none;
    margin: 10px;
    cursor: pointer;
    image-rendering: pixelated;
    transform: scale(2); /* buttons are 2x bigger */
  }
</style>
</head>
<body>
<div id="menu">
  <button id="btn2"><img src="images/buttons/start-menu/button-2-players.png"></button>
  <button id="btn3"><img src="images/buttons/start-menu/button-3-players.png"></button>
  <button id="btn4"><img src="images/buttons/start-menu/button-4-players.png"></button>
</div>

<div id="settings">
  <p>TIME (5â€“60 SEC): <input type="number" id="timeInput" min="5" max="60" value="20"></p>
  <button id="startBtn"><img src="images/buttons/start-gray.png" id="startImg"></button>
</div>

<div id="gameover">
  <h1 id="winnerText"></h1>
  <button onclick="location.reload()"><img src="images/buttons/restart.png"></button>
</div>

<canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;
ctx.imageSmoothingEnabled = false;

// Load images
let wallImg = new Image(); wallImg.src = "images/blocks/wall.png";
let groundImg = new Image(); groundImg.src = "images/blocks/ground-slab.png";

// Player images
let playerImgs = [
  { normal: new Image(), bomb: new Image() },
  { normal: new Image(), bomb: new Image() },
  { normal: new Image(), bomb: new Image() },
  { normal: new Image(), bomb: new Image() }
];
playerImgs[0].normal.src = "images/players/player-1.png";
playerImgs[0].bomb.src   = "images/players/player-1-bomb.png";
playerImgs[1].normal.src = "images/players/player-2.png";
playerImgs[1].bomb.src   = "images/players/player-2-bomb.png";
playerImgs[2].normal.src = "images/players/player-3.png";
playerImgs[2].bomb.src   = "images/players/player-3-bomb.png";
playerImgs[3].normal.src = "images/players/player-4.png";
playerImgs[3].bomb.src   = "images/players/player-4-bomb.png";

let restartImg = new Image(); restartImg.src = "images/buttons/restart.png";
let startGrayImg = new Image(); startGrayImg.src = "images/buttons/start-gray.png";
let startImg = new Image(); startImg.src = "images/buttons/start.png";

// Game state
let numPlayers = 2;
let players = [];
let map = [];
let tileSize = 48;
let rows = Math.floor(canvas.height / tileSize);
let cols = Math.floor(canvas.width / tileSize);

let bomb = null;
let timeLeft = 20;
let gameInterval;
let gameRunning = false;

// Key mapping
const controls = [
  {up:"KeyW",down:"KeyS",left:"KeyA",right:"KeyD",throw:"KeyQ"},
  {up:"ArrowUp",down:"ArrowDown",left:"ArrowLeft",right:"ArrowRight",throw:"Slash"},
  {up:"KeyI",down:"KeyK",left:"KeyJ",right:"KeyL",throw:"KeyU"},
  {up:"KeyT",down:"KeyG",left:"KeyF",right:"KeyH",throw:"KeyR"}
];
let keys = {};

document.addEventListener("keydown", e => keys[e.code]=true);
document.addEventListener("keyup", e => keys[e.code]=false);

// Menu logic
document.getElementById("menu").style.display="flex";
document.getElementById("btn2").onclick=()=>{numPlayers=2;showSettings();};
document.getElementById("btn3").onclick=()=>{numPlayers=3;showSettings();};
document.getElementById("btn4").onclick=()=>{numPlayers=4;showSettings();};

function showSettings(){
  document.getElementById("menu").style.display="none";
  document.getElementById("settings").style.display="flex";
}

let timeInput = document.getElementById("timeInput");
let startButton = document.getElementById("startBtn");
timeInput.oninput=()=>{
  let v=parseInt(timeInput.value);
  if(v>=5 && v<=60){
    document.getElementById("startImg").src="images/buttons/start.png";
    startButton.onclick=startGame;
  }else{
    document.getElementById("startImg").src="images/buttons/start-gray.png";
    startButton.onclick=null;
  }
};

function startGame(){
  document.getElementById("settings").style.display="none";
  initGame();
  gameRunning=true;
  gameInterval=setInterval(update,1000/60);
}

function initGame(){
  // Build map
  map=[];
  for(let r=0;r<rows;r++){
    let row=[];
    for(let c=0;c<cols;c++){
      if(r===0||c===0||r===rows-1||c===cols-1||Math.random()<0.1){
        row.push(1); // wall
      } else {
        row.push(0); // ground
      }
    }
    map.push(row);
  }
  // Players
  players=[];
  for(let i=0;i<numPlayers;i++){
    let px,py;
    do{
      px=Math.floor(Math.random()*cols);
      py=Math.floor(Math.random()*rows);
    }while(map[py][px]===1);
    players.push({x:px,y:py,speed:0.1,alive:true});
  }
  // Bomb
  bomb={holder:Math.floor(Math.random()*numPlayers),flying:false,x:0,y:0,vx:0,vy:0};
}

function update(){
  if(!gameRunning) return;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  // Draw map
  for(let r=0;r<rows;r++){
    for(let c=0;c<cols;c++){
      let img = map[r][c]===1?wallImg:groundImg;
      ctx.drawImage(img,c*tileSize,r*tileSize,tileSize,tileSize);
    }
  }
  // Player movement
  for(let i=0;i<numPlayers;i++){
    let p=players[i];
    if(!p.alive) continue;
    let ctrl=controls[i];
    let nx=p.x,ny=p.y;
    if(keys[ctrl.up]) ny-=p.speed*tileSize;
    if(keys[ctrl.down]) ny+=p.speed*tileSize;
    if(keys[ctrl.left]) nx-=p.speed*tileSize;
    if(keys[ctrl.right]) nx+=p.speed*tileSize;
    let gridX=Math.floor(nx/tileSize);
    let gridY=Math.floor(ny/tileSize);
    if(map[gridY] && map[gridY][gridX]===0){
      p.x=nx; p.y=ny;
    }
    // Draw player sprite
    let sprite=(bomb.holder===i)?playerImgs[i].bomb:playerImgs[i].normal;
    ctx.drawImage(sprite,p.x,p.y,tileSize,tileSize);
    // Throw bomb
    if(bomb.holder===i && keys[ctrl.throw]){
      bomb.holder=null;
      bomb.flying=true;
      bomb.x=p.x; bomb.y=p.y;
      bomb.vx=(keys[ctrl.left]?-1:keys[ctrl.right]?1:0)*4;
      bomb.vy=(keys[ctrl.up]?-1:keys[ctrl.down]?1:0)*4;
      if(bomb.vx===0 && bomb.vy===0) bomb.vx=4; // default right
    }
  }
  // Bomb flight
  if(bomb.flying){
    bomb.x+=bomb.vx;
    bomb.y+=bomb.vy;
    let gx=Math.floor(bomb.x/tileSize);
    let gy=Math.floor(bomb.y/tileSize);
    if(map[gy] && map[gy][gx]===1){ // hit wall -> stop
      bomb.flying=false;
      bomb.holder=Math.floor(Math.random()*numPlayers); // bounce back to random
    }
    ctx.drawImage(playerImgs[0].bomb,bomb.x,bomb.y,tileSize,tileSize); // reuse sprite for bomb
    // Check collision with players
    for(let i=0;i<numPlayers;i++){
      let p=players[i];
      if(!p.alive) continue;
      if(Math.abs(p.x-bomb.x)<tileSize/2 && Math.abs(p.y-bomb.y)<tileSize/2){
        bomb.flying=false;
        bomb.holder=i;
      }
    }
  }
  // Timer
  ctx.fillStyle="white";
  ctx.font="20px 'Press Start 2P'";
  ctx.fillText("TIME: "+Math.floor(timeLeft),20,30);
}

// Countdown
setInterval(()=>{
  if(gameRunning){
    timeLeft--;
    if(timeLeft<=0){
      if(bomb.holder!==null) players[bomb.holder].alive=false;
      let alivePlayers=players.filter(p=>p.alive);
      if(alivePlayers.length<=1){
        endGame();
      } else {
        timeLeft=20;
      }
    }
  }
},1000);

function endGame(){
  gameRunning=false;
  clearInterval(gameInterval);
  document.getElementById("gameover").style.display="flex";
  let winnerIndex=players.findIndex(p=>p.alive);
  document.getElementById("winnerText").innerText=(winnerIndex>=0?("Player "+(winnerIndex+1)+" Wins!"):("Draw!"));
}
</script>
</body>
</html>
