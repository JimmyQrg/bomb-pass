<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Bomb Pass</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      background: #000;
      font-family: 'Press Start 2P', monospace;
      image-rendering: pixelated;
      overflow: hidden;
    }

    /* Centering all menus */
    .menu {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background: url("images/background.png") no-repeat center center;
      background-size: cover;
    }

    .menu img {
      width: 300px; /* 2× bigger */
      margin: 15px 0;
      cursor: pointer;
      image-rendering: pixelated;
    }

    #gameCanvas {
      display: none;
      background: #000;
    }

    #timer {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      color: white;
      font-size: 16px;
      font-family: 'Press Start 2P', monospace;
    }

    #gameover {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: url("images/background.png") no-repeat center center;
      background-size: cover;
      color: white;
      font-family: 'Press Start 2P', monospace;
    }

    #gameover img {
      margin-top: 20px;
      width: 300px; /* Restart button also 2× bigger */
      cursor: pointer;
      image-rendering: pixelated;
    }
  </style>
</head>
<body>
  <!-- Start Menu -->
  <div id="startMenu" class="menu">
    <img id="btn2" src="images/buttons/start-menu/button-2-players.png">
    <img id="btn3" src="images/buttons/start-menu/button-3-players.png">
    <img id="btn4" src="images/buttons/start-menu/button-4-players.png">
  </div>

  <!-- Game Settings -->
  <div id="settingsMenu" class="menu" style="display:none;">
    <label style="color:white;">Time (5-60s):</label>
    <input id="timeInput" type="number" value="30" min="5" max="60"
           style="font-family:'Press Start 2P'; font-size:16px; text-align:center;">
    <br>
    <img id="startBtn" src="images/buttons/start-gray.png">
  </div>

  <!-- Timer -->
  <div id="timer"></div>

  <!-- Game Canvas -->
  <canvas id="gameCanvas" width="640" height="480"></canvas>

  <!-- Game Over Screen -->
  <div id="gameover">
    <h1 id="winnerText"></h1>
    <img id="restartBtn" src="images/buttons/restart.png">
  </div>

  <script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    let gameInterval, timerInterval;
    let players = [];
    let bomb = null;
    let gameTime = 30;
    let totalPlayers = 2;
    const tileSize = 32;
    const mapWidth = 20;
    const mapHeight = 15;
    let map = [];

    // Controls
    const controls = [
      {up:'KeyW', down:'KeyS', left:'KeyA', right:'KeyD', throw:'KeyQ', dash:'KeyE'},
      {up:'ArrowUp', down:'ArrowDown', left:'ArrowLeft', right:'ArrowRight', throw:'Slash', dash:'ShiftRight'},
      {up:'KeyI', down:'KeyK', left:'KeyJ', right:'KeyL', throw:'KeyU', dash:'KeyO'},
      {up:'KeyT', down:'KeyG', left:'KeyF', right:'KeyH', throw:'KeyR', dash:'KeyY'}
    ];

    // Start menu buttons
    document.getElementById("btn2").onclick = ()=>{ totalPlayers=2; openSettings(); };
    document.getElementById("btn3").onclick = ()=>{ totalPlayers=3; openSettings(); };
    document.getElementById("btn4").onclick = ()=>{ totalPlayers=4; openSettings(); };

    function openSettings(){
      document.getElementById("startMenu").style.display="none";
      document.getElementById("settingsMenu").style.display="flex";
    }

    document.getElementById("timeInput").addEventListener("input", e=>{
      let val = parseInt(e.target.value);
      let startBtn = document.getElementById("startBtn");
      if(val>=5 && val<=60){
        gameTime = val;
        startBtn.src = "images/buttons/start.png";
        startBtn.onclick=startGame;
      } else {
        startBtn.src = "images/buttons/start-gray.png";
        startBtn.onclick=null;
      }
    });

    // Generate map
    function generateMap(){
      map=[];
      for(let y=0;y<mapHeight;y++){
        let row=[];
        for(let x=0;x<mapWidth;x++){
          if(x===0 || y===0 || x===mapWidth-1 || y===mapHeight-1 || Math.random()<0.1){
            row.push("wall");
          } else {
            row.push("ground");
          }
        }
        map.push(row);
      }
    }

    // Start game
    function startGame(){
      document.getElementById("settingsMenu").style.display="none";
      canvas.style.display="block";
      document.getElementById("timer").style.display="block";
      generateMap();
      players=[];
      for(let i=0;i<totalPlayers;i++){
        players.push({x:tileSize*(2+i*3), y:tileSize*2, w:28, h:28, color:`hsl(${i*90},80%,60%)`, alive:true, hasBomb:false, ctrl:controls[i], dashCD:0});
      }
      bomb = {holder:Math.floor(Math.random()*totalPlayers)};
      players[bomb.holder].hasBomb=true;

      startTimer();
      gameInterval = setInterval(updateGame, 1000/60);
    }

    function startTimer(){
      let timeLeft = gameTime;
      document.getElementById("timer").innerText=timeLeft;
      timerInterval=setInterval(()=>{
        timeLeft--;
        document.getElementById("timer").innerText=timeLeft;
        if(timeLeft<=0){
          clearInterval(timerInterval);
          explodeBomb();
        }
      },1000);
    }

    function explodeBomb(){
      let loser = bomb.holder;
      players[loser].alive=false;
      players[loser].hasBomb=false;
      let alivePlayers = players.filter(p=>p.alive);
      if(alivePlayers.length===1){
        endGame(alivePlayers[0]);
      } else {
        bomb.holder = alivePlayers[Math.floor(Math.random()*alivePlayers.length)];
        players[bomb.holder].hasBomb=true;
        startTimer();
      }
    }

    function endGame(winner){
      clearInterval(gameInterval);
      clearInterval(timerInterval);
      canvas.style.display="none";
      document.getElementById("timer").style.display="none";
      document.getElementById("gameover").style.display="flex";
      document.getElementById("winnerText").innerText=`Player ${players.indexOf(winner)+1} Wins!`;
    }

    document.getElementById("restartBtn").onclick=()=>location.reload();

    // Input
    let keys={};
    window.addEventListener("keydown",e=>{keys[e.code]=true;});
    window.addEventListener("keyup",e=>{keys[e.code]=false;});

    // Game loop
    function updateGame(){
      ctx.clearRect(0,0,canvas.width,canvas.height);

      // Draw map
      for(let y=0;y<mapHeight;y++){
        for(let x=0;x<mapWidth;x++){
          let tile=map[y][x];
          let img=new Image();
          img.src = tile==="wall"?"images/blocks/wall.png":"images/blocks/ground-slab.png";
          ctx.drawImage(img,x*tileSize,y*tileSize,tileSize,tileSize);
        }
      }

      // Update players
      players.forEach((p,i)=>{
        if(!p.alive) return;

        let speed=2;
        if(keys[p.ctrl.up]) p.y-=speed;
        if(keys[p.ctrl.down]) p.y+=speed;
        if(keys[p.ctrl.left]) p.x-=speed;
        if(keys[p.ctrl.right]) p.x+=speed;

        // Dash
        if(keys[p.ctrl.dash] && p.dashCD<=0){
          p.x+= (keys[p.ctrl.left]?-50:0)+(keys[p.ctrl.right]?50:0);
          p.y+= (keys[p.ctrl.up]?-50:0)+(keys[p.ctrl.down]?50:0);
          p.dashCD=60;
        }
        if(p.dashCD>0) p.dashCD--;

        // Boundaries
        if(p.x<0)p.x=0;
        if(p.y<0)p.y=0;
        if(p.x>canvas.width-p.w)p.x=canvas.width-p.w;
        if(p.y>canvas.height-p.h)p.y=canvas.height-p.h;

        ctx.fillStyle=p.color;
        ctx.fillRect(p.x,p.y,p.w,p.h);

        // Bomb throw
        if(p.hasBomb && keys[p.ctrl.throw]){
          for(let j=0;j<players.length;j++){
            if(i!==j && players[j].alive &&
              Math.abs(players[j].x-p.x)<32 && Math.abs(players[j].y-p.y)<32){
              players[j].hasBomb=true;
              p.hasBomb=false;
              bomb.holder=j;
            }
          }
        }
      });

      // Draw bomb
      if(bomb && players[bomb.holder]){
        let holder=players[bomb.holder];
        let img=new Image();
        img.src="images/bomb.png";
        ctx.drawImage(img,holder.x,holder.y-20,24,24);
      }
    }
  </script>
</body>
</html>
