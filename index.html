<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Bomb Pass</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  overflow: hidden;
  font-family: 'Press Start 2P', monospace;
  image-rendering: pixelated;
  background: #000;
}
.menu {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100vh;
  background: url("images/background.png") no-repeat center center;
  background-size: cover;
}
.menu img {
  width: 300px;
  margin: 15px 0;
  cursor: pointer;
  image-rendering: pixelated;
}
#gameCanvas { display: none; background: #000; }
#timer {
  position: absolute;
  top: 10px;
  left: 50%;
  transform: translateX(-50%);
  color: white;
  font-size: 18px;
  z-index: 100;
}
#gameover {
  display: none;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  position: absolute;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: url("images/background.png") no-repeat center center;
  background-size: cover;
  color: white;
  font-family: 'Press Start 2P', monospace;
}
#gameover img {
  margin-top: 20px;
  width: 300px;
  cursor: pointer;
  image-rendering: pixelated;
}
</style>
</head>
<body>
<div id="startMenu" class="menu">
  <img id="btn2" src="images/buttons/start-menu/button-2-players.png">
  <img id="btn3" src="images/buttons/start-menu/button-3-players.png">
  <img id="btn4" src="images/buttons/start-menu/button-4-players.png">
</div>

<div id="settingsMenu" class="menu" style="display:none;">
  <label style="color:white;">Time (5-60s):</label>
  <input id="timeInput" type="number" value="30" min="5" max="60" style="font-family:'Press Start 2P'; font-size:16px; text-align:center;">
  <br>
  <img id="startBtn" src="images/buttons/start-gray.png">
</div>

<div id="timer"></div>
<canvas id="gameCanvas"></canvas>

<div id="gameover">
  <h1 id="winnerText"></h1>
  <img id="restartBtn" src="images/buttons/restart.png">
</div>

<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
function resizeCanvas(){ canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

let gameInterval, timerInterval;
let players = [];
let bomb = null;
let bombFlying = null;
let gameTime = 30;
let totalPlayers = 2;

// Preload images
const wallImg = new Image(); wallImg.src="images/blocks/wall.png";
const groundImg = new Image(); groundImg.src="images/blocks/ground-slab.png";
const bombImg = new Image(); bombImg.src="images/bomb.png";

const tileSize = 32;
let mapWidth = 20;
let mapHeight = 15;
let map = [];

const controls = [
  {up:'KeyW', down:'KeyS', left:'KeyA', right:'KeyD', throw:'KeyQ'},
  {up:'ArrowUp', down:'ArrowDown', left:'ArrowLeft', right:'ArrowRight', throw:'Slash'},
  {up:'KeyI', down:'KeyK', left:'KeyJ', right:'KeyL', throw:'KeyU'},
  {up:'KeyT', down:'KeyG', left:'KeyF', right:'KeyH', throw:'KeyR'}
];

document.getElementById("btn2").onclick = ()=>{ totalPlayers=2; openSettings(); };
document.getElementById("btn3").onclick = ()=>{ totalPlayers=3; openSettings(); };
document.getElementById("btn4").onclick = ()=>{ totalPlayers=4; openSettings(); };

function openSettings(){
  document.getElementById("startMenu").style.display="none";
  document.getElementById("settingsMenu").style.display="flex";
  validateTime();
}

const timeInput = document.getElementById("timeInput");
const startBtn = document.getElementById("startBtn");

function validateTime(){
  const val = parseInt(timeInput.value);
  if(val >= 5 && val <= 60){
    startBtn.src = "images/buttons/start.png";
    startBtn.onclick=startGame;
  } else {
    startBtn.src = "images/buttons/start-gray.png";
    startBtn.onclick=null;
  }
}
timeInput.addEventListener("input", validateTime);

function generateMap(){
  map=[];
  for(let y=0;y<mapHeight;y++){
    let row=[];
    for(let x=0;x<mapWidth;x++){
      if(x===0 || y===0 || x===mapWidth-1 || y===mapHeight-1 || Math.random()<0.1){
        row.push("wall");
      } else {
        row.push("ground");
      }
    }
    map.push(row);
  }
}

function findFreeTile() {
  for(let y=1;y<mapHeight-1;y++){
    for(let x=1;x<mapWidth-1;x++){
      if(map[y][x]==="ground"){
        return {x:x*tileSize, y:y*tileSize};
      }
    }
  }
  return {x:tileSize, y:tileSize};
}

function startGame(){
  document.getElementById("settingsMenu").style.display="none";
  canvas.style.display="block";
  document.getElementById("timer").style.display="block";
  generateMap();
  players=[];
  for(let i=0;i<totalPlayers;i++){
    let spawn = {x:tileSize*(2+i*3), y:tileSize*2};
    if(!canMove(spawn.x, spawn.y, 28, 28)){
      spawn = findFreeTile();
    }
    players.push({
      x:spawn.x, y:spawn.y, w:28, h:28,
      color:`hsl(${i*90},80%,60%)`,
      alive:true, hasBomb:false, ctrl:controls[i]
    });
  }
  bomb = {holder:Math.floor(Math.random()*totalPlayers)};
  players[bomb.holder].hasBomb=true;
  bombFlying = null;

  startTimer();
  gameInterval = setInterval(updateGame, 1000/60);
}

function startTimer(){
  let timeLeft = parseInt(timeInput.value);
  document.getElementById("timer").innerText=timeLeft;
  timerInterval=setInterval(()=>{
    timeLeft--;
    document.getElementById("timer").innerText=timeLeft;
    if(timeLeft<=0){
      clearInterval(timerInterval);
      explodeBomb();
    }
  },1000);
}

function explodeBomb(){
  let loser = bomb.holder;
  players[loser].alive=false;
  players[loser].hasBomb=false;
  bombFlying = null;
  let alivePlayers = players.filter(p=>p.alive);
  if(alivePlayers.length===1){
    endGame(alivePlayers[0]);
  } else {
    bomb.holder = alivePlayers[Math.floor(Math.random()*alivePlayers.length)];
    players[bomb.holder].hasBomb=true;
    startTimer();
  }
}

function endGame(winner){
  clearInterval(gameInterval);
  clearInterval(timerInterval);
  canvas.style.display="none";
  document.getElementById("timer").style.display="none";
  document.getElementById("gameover").style.display="flex";
  document.getElementById("winnerText").innerText=`Player ${players.indexOf(winner)+1} Wins!`;
}
document.getElementById("restartBtn").onclick=()=>location.reload();

let keys={};
window.addEventListener("keydown",e=>{keys[e.code]=true;});
window.addEventListener("keyup",e=>{keys[e.code]=false;});

function canMove(x, y, w, h){
  const left = Math.floor(x / tileSize);
  const right = Math.floor((x+w-1) / tileSize);
  const top = Math.floor(y / tileSize);
  const bottom = Math.floor((y+h-1) / tileSize);
  for(let i=top;i<=bottom;i++){
    for(let j=left;j<=right;j++){
      if(map[i] && map[i][j]==="wall") return false;
    }
  }
  return true;
}

function updateGame(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  const scaleX = canvas.width/mapWidth/tileSize;
  const scaleY = canvas.height/mapHeight/tileSize;

  // Draw map
  for(let y=0;y<mapHeight;y++){
    for(let x=0;x<mapWidth;x++){
      let img = map[y][x]==="wall"?wallImg:groundImg;
      ctx.drawImage(img, x*tileSize*scaleX, y*tileSize*scaleY, tileSize*scaleX, tileSize*scaleY);
    }
  }

  players.forEach((p,i)=>{
    if(!p.alive) return;
    let speed=2;
    let newX = p.x;
    let newY = p.y;
    if(keys[p.ctrl.up]) newY-=speed;
    if(keys[p.ctrl.down]) newY+=speed;
    if(keys[p.ctrl.left]) newX-=speed;
    if(keys[p.ctrl.right]) newX+=speed;

    if(canMove(newX, p.y, p.w, p.h)) p.x=newX;
    if(canMove(p.x, newY, p.w, p.h)) p.y=newY;

    ctx.fillStyle=p.color;
    ctx.fillRect(p.x*scaleX, p.y*scaleY, p.w*scaleX, p.h*scaleY);

    // Throw bomb
    if(p.hasBomb && keys[p.ctrl.throw] && !bombFlying){
      let nearest = null;
      let dist = Infinity;
      players.forEach((t,j)=>{
        if(i!==j && t.alive){
          let d = Math.hypot(t.x - p.x, t.y - p.y);
          if(d<dist){ dist=d; nearest=t; }
        }
      });
      if(nearest){
        bombFlying = {x: p.x, y: p.y-10, target: nearest, speed: 6, from: p};
        p.hasBomb = false;
        bomb.holder = null;
      }
    }
  });

  // Update flying bomb
  if(bombFlying){
    let dx = bombFlying.target.x - bombFlying.x;
    let dy = bombFlying.target.y - bombFlying.y;
    let dist = Math.hypot(dx, dy);
    if(dist < 4){
      bombFlying.target.hasBomb = true;
      bombFlying = null;
      bomb.holder = players.indexOf(bombFlying.target);
    } else {
      bombFlying.x += dx/dist * bombFlying.speed;
      bombFlying.y += dy/dist * bombFlying.speed;
    }
    ctx.drawImage(bombImg, bombFlying.x*scaleX, bombFlying.y*scaleY, 24*scaleX, 24*scaleY);
  }

  // Bomb holder display
  if(bomb && bomb.holder!==null){
    let holder=players[bomb.holder];
    ctx.drawImage(bombImg, holder.x*scaleX, (holder.y-20)*scaleY, 24*scaleX, 24*scaleY);
  }
}
</script>
</body>
</html>
