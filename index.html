<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Bomb Pass</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

  <style>
    body {
      margin: 0;
      background: #000;
      font-family: 'Press Start 2P', monospace;
      color: white;
      text-align: center;
      image-rendering: pixelated;
    }
    canvas {
      display: block;
      margin: 0 auto;
      background: #000;
      image-rendering: pixelated;
      border: 4px solid #444;
    }
    #menu, #settings, #gameover {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: none;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      border-radius: 12px;
      font-family: 'Press Start 2P', monospace;
      color: white;
      text-shadow: 2px 2px #111;
      image-rendering: pixelated;
    }
    #menu, #settings, #gameover {
      background: url("images/background.png");
      background-size: cover;
    }
    button {
      background: none;
      border: none;
      margin: 6px;
      cursor: pointer;
      image-rendering: pixelated;
    }
    button img {
      width: 33%; /* buttons 3x smaller */
      height: auto;
      image-rendering: pixelated;
    }
    input {
      text-align: center;
      font-size: 14px;
      width: 80px;
      font-family: 'Press Start 2P', monospace;
    }
  </style>
</head>
<body>
  <!-- MENU -->
  <div id="menu">
    <button id="btn2"><img src="images/buttons/start-menu/button-2-players.png"></button>
    <button id="btn3"><img src="images/buttons/start-menu/button-3-players.png"></button>
    <button id="btn4"><img src="images/buttons/start-menu/button-4-players.png"></button>
  </div>

  <!-- SETTINGS -->
  <div id="settings">
    <p>TIME (5â€“60 SEC): <input type="number" id="timeInput" min="5" max="60" value="20"></p>
    <button id="startBtn"><img src="images/buttons/start-gray.png" id="startImg"></button>
  </div>

  <!-- GAME OVER -->
  <div id="gameover">
    <h1 id="winnerText"></h1>
    <button onclick="location.reload()"><img src="images/buttons/restart.png"></button>
  </div>

  <!-- CANVAS -->
  <canvas id="gameCanvas" width="800" height="600"></canvas>

  <script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    ctx.imageSmoothingEnabled = false;

    let gameRunning = false;
    let players = [];
    let bomb = null;
    let gameTime = 20;
    let timeLeft = 20;
    let timerInterval = null;

    // Controls per player
    const playerKeys = [
      { up:"w", down:"s", left:"a", right:"d", throw:"q", dash:"e" },      // P1
      { up:"ArrowUp", down:"ArrowDown", left:"ArrowLeft", right:"ArrowRight", throw:"/", dash:"Shift" }, // P2
      { up:"i", down:"k", left:"j", right:"l", throw:"u", dash:"o" },      // P3
      { up:"t", down:"g", left:"f", right:"h", throw:"r", dash:"y" }       // P4
    ];

    // Player class
    class Player {
      constructor(x, y, color, keys) {
        this.x = x; this.y = y;
        this.size = 30;
        this.color = color;
        this.keys = keys;
        this.hasBomb = false;
        this.vx = 0; this.vy = 0;
        this.dashCooldown = 0;
      }
      draw() {
        ctx.fillStyle = this.color;
        ctx.fillRect(this.x, this.y, this.size, this.size);
      }
      move(input) {
        let speed = 3;
        let dx=0, dy=0;
        if (input[this.keys.up]) dy -= speed;
        if (input[this.keys.down]) dy += speed;
        if (input[this.keys.left]) dx -= speed;
        if (input[this.keys.right]) dx += speed;

        this.x += dx + this.vx;
        this.y += dy + this.vy;

        // friction
        this.vx *= 0.8;
        this.vy *= 0.8;

        // bounds
        this.x = Math.max(0, Math.min(canvas.width - this.size, this.x));
        this.y = Math.max(0, Math.min(canvas.height - this.size, this.y));
      }
      dash(input) {
        if (this.dashCooldown <= 0 && input[this.keys.dash]) {
          let dashPower = 12;
          let dx = 0, dy = 0;
          if (input[this.keys.up]) dy -= 1;
          if (input[this.keys.down]) dy += 1;
          if (input[this.keys.left]) dx -= 1;
          if (input[this.keys.right]) dx += 1;
          if (dx !== 0 || dy !== 0) {
            this.vx = dx * dashPower;
            this.vy = dy * dashPower;
            this.dashCooldown = 30;
          }
        }
        if (this.dashCooldown > 0) this.dashCooldown--;
      }
    }

    // Bomb
    class Bomb {
      constructor(holder) {
        this.holder = holder;
        holder.hasBomb = true;
      }
      update(input) {
        if (this.holder && input[this.holder.keys.throw]) {
          let dirX = (input[this.holder.keys.left]? -1:0) + (input[this.holder.keys.right]? 1:0);
          let dirY = (input[this.holder.keys.up]? -1:0) + (input[this.holder.keys.down]? 1:0);
          if (dirX!==0 || dirY!==0) {
            this.holder.hasBomb = false;
            this.x = this.holder.x;
            this.y = this.holder.y;
            this.vx = dirX*6;
            this.vy = dirY*6;
            this.holder = null;
          }
        } else if (!this.holder) {
          this.x += this.vx;
          this.y += this.vy;

          if (this.x < 0 || this.x > canvas.width) { this.vx *= -1; }
          if (this.y < 0 || this.y > canvas.height) { this.vy *= -1; }

          for (let p of players) {
            if (this.x < p.x+p.size && this.x+20 > p.x && this.y < p.y+p.size && this.y+20 > p.y) {
              this.holder = p;
              p.hasBomb = true;
              break;
            }
          }
        }
      }
      draw() {
        if (this.holder) {
          ctx.fillStyle = "yellow";
          ctx.fillRect(this.holder.x+5, this.holder.y-10, 20, 20);
        } else {
          ctx.fillStyle = "orange";
          ctx.fillRect(this.x, this.y, 20, 20);
        }
      }
    }

    // Input
    let input = {};
    document.addEventListener("keydown", e=>{ input[e.key]=true; });
    document.addEventListener("keyup", e=>{ input[e.key]=false; });

    function startGame(nPlayers, seconds) {
      players = [];
      const colors = ["red","blue","green","purple"];
      for (let i=0;i<nPlayers;i++) {
        players.push(new Player(100+ i*100, 300, colors[i], playerKeys[i]));
      }
      bomb = new Bomb(players[Math.floor(Math.random()*nPlayers)]);
      gameTime = seconds;
      timeLeft = seconds;
      gameRunning = true;
      document.getElementById("menu").style.display="none";
      document.getElementById("settings").style.display="none";
      timerInterval = setInterval(()=> {
        timeLeft--;
        if (timeLeft<=0) {
          explode();
        }
      },1000);
      gameLoop();
    }

    function explode() {
      if (bomb.holder) {
        let loser = bomb.holder;
        players = players.filter(p=>p!==loser);
      }
      if (players.length<=1) {
        gameRunning=false;
        clearInterval(timerInterval);
        document.getElementById("gameover").style.display="flex";
        document.getElementById("winnerText").innerText = players[0]? (players[0].color.toUpperCase()+" WINS!") : "NO WINNER";
      } else {
        timeLeft=gameTime;
        bomb = new Bomb(players[Math.floor(Math.random()*players.length)]);
      }
    }

    function gameLoop() {
      if (!gameRunning) return;
      ctx.clearRect(0,0,canvas.width,canvas.height);

      ctx.fillStyle="white";
      ctx.font="16px 'Press Start 2P'";
      ctx.fillText("TIME: "+timeLeft, 20,20);

      for (let p of players) {
        p.move(input);
        p.dash(input);
        p.draw();
      }
      bomb.update(input);
      bomb.draw();

      requestAnimationFrame(gameLoop);
    }

    // Menu
    const menu = document.getElementById("menu");
    const settings = document.getElementById("settings");
    menu.style.display="flex";

    let chosenPlayers=2;
    document.getElementById("btn2").onclick=()=>{chosenPlayers=2; menu.style.display="none"; settings.style.display="flex";}
    document.getElementById("btn3").onclick=()=>{chosenPlayers=3; menu.style.display="none"; settings.style.display="flex";}
    document.getElementById("btn4").onclick=()=>{chosenPlayers=4; menu.style.display="none"; settings.style.display="flex";}

    const timeInput = document.getElementById("timeInput");
    const startBtn = document.getElementById("startBtn");
    const startImg = document.getElementById("startImg");
    timeInput.addEventListener("input", ()=>{
      if (timeInput.value>=5 && timeInput.value<=60) {
        startImg.src="images/buttons/start.png";
        startBtn.disabled=false;
      } else {
        startImg.src="images/buttons/start-gray.png";
        startBtn.disabled=true;
      }
    });
    startBtn.onclick=()=>{
      if (timeInput.value>=5 && timeInput.value<=60) {
        startGame(chosenPlayers, parseInt(timeInput.value));
      }
    }
  </script>
</body>
</html>
